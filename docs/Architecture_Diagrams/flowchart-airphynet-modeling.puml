@startuml Flowchart - AirPhyNet Horizontal
title Flowchart - AirPhyNet Modeling Process
!theme plain
skinparam shadowng false

start

:Start Pipeline;

:Init DagsHub & MLflow; <<task>>

group "Drift Check & Data Loading"
    :Start Scheduled Job (Daily);
    :<b>Run Drift Detector</b>\n(KS-Test on Last 24h vs 7d);
    
    if (Drift Detected?) then (Yes)
        :Fetch Training Data from MongoDB\n(Last 30 Days);
        :Dynamic Feature Selection;
        :Create Time Series\n(Window Size = 24);
    else (No)
        :End Process (No Retraining);
        stop
    endif
end group

' Percabangan untuk memisahkan Dataset
fork
    ' === JALUR ATAS: TRAINING ===
    :Train Set;
    
    group "Model Initialization"
        :Init AirPhyNet Model\n(LSTM + Physics);
        :Define Loss (MSE) & Opt (Adam);
    end group

    group "Training Phase"
        :Start Training Loop;
        while (Epoch < 50?) is (Yes)
            :Forward Pass & Calc Loss;
            :<b>Calc Physics Loss</b>\n(Advection-Diffusion);
            :Update Weights;
        endwhile (No)
        :Log to MLflow;
    end group

fork again
    ' === JALUR BAWAH: TESTING ===
    :Test Set;
    
    group "Inference Prep"
        :Convert to Tensors;
        :Create DataLoaders;
    end group
end fork

group "Evaluation & Logging"
    :Predict on Test Set;
    :Calculate Metrics (MSE, R2);
    
    if (Metrics OK?) then (Yes)
        :Log Metrics & Artifacts;
        :Register Model "AirPhyNet";
        :<b>Promote to Production</b>;
    else (No)
        :Tuning Hyperparams;
        stop
    endif
end group

:End Process;

stop
@enduml
