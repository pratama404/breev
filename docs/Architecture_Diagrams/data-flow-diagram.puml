@startuml Data Flow Diagram
!theme plain

title Data Flow Diagram - Level 1 (AirPhyNet)

!define PROCESS circle
!define DATASTORE rectangle
!define EXTERNAL actor

EXTERNAL Sensor as "IoT Sensor\n(ESP32)"
EXTERNAL User as "Building\nOccupant"
EXTERNAL Admin as "System\nAdmin"
EXTERNAL Cloud as "DagsHub\n(MLflow)"

PROCESS P1 as "1.0\nData\nIngestion"
PROCESS P2 as "2.0\nML Model\nTraining"
PROCESS P3 as "3.0\nData\nServing"

DATASTORE D1 as "D1: Sensor Logs"
DATASTORE D2 as "D2: Device Registry"
DATASTORE D3 as "D3: Model Registry"

' Data Acquisition Flow
Sensor --> P1 : MQTT Telemetry\n(JSON Payload)
P1 --> D1 : Store Readings\n(TimeSeries)
P1 --> D2 : Update Last Seen\n(Heartbeat)

' ML Pipeline Flow
D1 --> P2 : Fetch Historical\nData (Batch)
P2 --> Cloud : Log Experiments\n(Metrics, Params)
P2 --> D3 : Save Best Model\n(.pth)

' User Interaction Flow
User --> P3 : Scan QR Code\n(Get Room Data)
P3 --> D1 : Query Latest AQI
D1 --> P3 : Return Sensor Data
P3 --> User : Render Gauge & Recs

' Admin Interaction Flow
Admin --> P3 : View Dashboard
P3 --> D2 : Query Device Status
D2 --> P3 : Return Online/Offline
P3 --> D1 : Aggregate Metrics
D1 --> P3 : Avg AQI / CO2 Trends
P3 --> Admin : Render Charts & Lists

@enduml