@startuml Sequence - IoT Ingestion
title Ref: UC-CORE-01 (Send Sensor Data)

participant "ESP32 Device" as IoT
participant "Cloudflare Tunnel" as Tunnel
participant "FastAPI Backend" as API
database "MongoDB Atlas" as DB

== Initialization ==
IoT -> IoT: Connect WiFi
IoT -> IoT: Read API_KEY from Memory

== Ingestion Loop (Every 30s) ==
IoT -> IoT: Read DHT22 (Temp/Hum)
IoT -> IoT: Read MQ135 (Gas)
IoT -> Tunnel: POST /ingest (JSON) + x-api-keyheader
note right: Payload: {sensor_id, temp, hum, co2}

Tunnel -> API: SSL Forwarding
activate API

API -> API: Check x-api-key
alt Invalid Key
    API --> Tunnel: 401 Unauthorized
    Tunnel --> IoT: 401 Error
else Valid Key
    API -> DB: Insert into 'sensor_logs'
    activate DB
    DB --> API: Success (ObjectId)
    deactivate DB
    API --> Tunnel: 200 OK
    Tunnel --> IoT: 200 OK
end

deactivate API
@enduml